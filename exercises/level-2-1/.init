#!/usr/local/bin/python3
import os
from pathlib import Path
import random
import shutil
import subprocess
import re  

result = subprocess.run(["findmnt", "-n", "--raw", "-o", "SOURCE", "/home/hacker"], capture_output=True, text=True)
brackets = re.findall(r'\[([^\]]*)\]', result.stdout)
digits = re.findall(r'\d+', brackets[0]) if brackets else []
Dojo_User_Id = int(digits[0]) if digits else None

random.seed(Dojo_User_Id)
unused_random_float = random.random()
study = 'fd' if Dojo_User_Id % 2 == 0 else 'oss'
#difficulty = random.randint(1, 3)

#study = 'oss'

path = Path(f'/challenge/study-{study}')
count = sum(1 for item in os.listdir(path) if item.isdigit() and (path / item).is_dir())

#pick any value except for the value of the other challenge
exclude = random.randint(0, count-1) #level 
#available = [i for i in range(count) if i != exclude]
#newrandom = random.choice(available)


#no more snappy oss=only fd
#no more unrar oss=only fd
#no more openjpeg fd-only oss

#testing
#exclude = 4



if exclude in [0, 3, 4]:
    study = 'oss'
elif exclude in [1, 2]:
    study = 'fd'

#path = Path(f'/challenge/study-{study}-{difficulty}')
path = Path(f'/challenge/study-{study}')

#C 0
#G 1
#O 2
#S 3
#U 4

#S->G
#G->S 
#O->U 
#U->O 
#C->G


if study == 'oss':
    #random.seed(Dojo_User_Id*7331)
    with open("/etc/bash.bashrc", "a") as f:
        f.write("source /usr/local/sbin/ossfuzz\n")

# Mapping: exclude -> newrandom
mapping = {
    0: 1,
    1: 3,
    2: 4,
    3: 1,
    4: 2
}

newrandom = mapping.get(exclude, exclude)  # Use mapping, fall back to exclude if not in map

subdir = path / str(newrandom)
#subdir = path / str("0")

for file in subdir.iterdir():
    shutil.move(str(file), f"/challenge/{file.name}")

Path(__file__).unlink()
shutil.rmtree(f'/challenge/study-fd', ignore_errors=True)
shutil.rmtree(f'/challenge/study-oss', ignore_errors=True)
